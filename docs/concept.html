<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en"><head>

<title>Концепция объектов в Fallout2</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- base href="http://teamx.ru/" -->
<style type="text/css">
</style>
</head><body>
<div class="section-1">
<div id="node-97" class="section-2">
<h1 class="book-heading">Концепция объектов в Fallout2</h1>
<p>В этом документе сделана попытка как-то упорядочить накопившиеся
знания по внутренней структуре Fallout 2. Этот документ не претендует
на полноту изложения, тем не менее одну из основополагающих концепций
Falloutостроения он излагает.</p>

<p>Прежде чем приступить к изучению этого документа, рекомендуется ознакомится с "Файловой структурой Fallout 2".</p>

<p><b>Авторы:</b><br>
Автор первоначальной версии: <b>Serge</b> (<a href="mailto:w_master@softhome.net">w_master@softhome.net</a>).<br>
Автор дополнений: <b>Perceptron</b> (<a href="mailto:perceptron@pisem.net">perceptron@pisem.net</a>).</p><div id="node-98" class="section-3">
<h1 class="book-heading">1. Введение</h1>
<p></p><div id="node-99" class="section-4">
<h1 class="book-heading">1.1. Игровые объекты</h1>
<p>Игровые объекты мы разделим на три группы (см. рисунок).</p>
<p></p><center><img alt="Global" src="concept_files/global.gif" border="0"></center>
<p>Описывая первую группу, удобнее начать с <i>карты мира</i>. Двигаясь по ней, игрок заходит в <i>города</i> и натыкается на <i>случайные встречи</i> в пустыне. При этом загружается <i>карта местности</i>, на которой и находятся игровые <i>объекты</i>.</p>
<p>Вторая группа - <i>игрок</i> и связанные с ним объекты - его <i>команда</i> (сопартийцы) и <i>машина</i>. Куда игрок, туда и они.</p>
<p>Третья группа - объекты <i>интерфейса</i>. Такие, как <i>видеоролики</i>.</p>
<p>(В тексте будет встречаться много рисунков, поэтому запомните
следующее: квадраты - это объекты, стрелки - связи между объектами,
подписи к стрелкам - идентификаторы, посредством которых происходит
обращение к объектам. Штриховой линией обозначены сложные объекты,
состоящие из набора других объектов. Пунктирной линией показаны
косвенные связи.)</p></div>
<div id="node-100" class="section-4">
<h1 class="book-heading">1.2. Обращение к объектам</h1>
<p>
Обращение к информации, связанной с объектами, происходит посредством <i>указателей</i>, а именно:<br>
</p>

<ul>
<ul><i>для файла:</i></ul>
1. По имени файла.<br>
2. Посредством идентификатора.<br>
<ul><i>для записи в текстовом файле:</i></ul>
3. По номеру записи.<br>
4. По имени записи.<br>
</ul>
<p>
Указатели по большей части содержатся в файлах игры (в текстовом или
двоичном виде), но они могут быть в некоторых случаях жестко прошиты в
движке (чаще всего это имена файлов).
</p>
<p>Идентификатор (ID) - это число (DWORD), в котором указывается тип
объекта, иногда некоторые параметры, а также номер (индекс) строки в
файле-списке, в которой записано имя файла. Здесь, как видите, для
получения имени файла используется промежуточный объект - файл-список
(LST файл). Иногда используется не весь ID, а просто лист-индекс.
</p>
<p>
Номер записи - число, которое соответствует блоку данных (иногда просто строке) в текстовом файле.
</p>
<p>
Имя записи - название, соответсвующее блоку данных в текстовом файле.
</p>
<p>
Проще говоря, обращение происходит к файлу или к записи в текстовом файле посредством либо имени, либо номера.
</p>
<p>
Список указателей:
</p>
<ul>
FL NAME - file name, имя файла<br>
<ul><i>лист-индексы и идентификаторы:</i></ul>
MVE IDX - mve index, номер видеоролика<br>
LST IDX - list index, номер в файле-списке (LST файл)<br>
PID - Proto ID, идентификатор прототипа<br>
FID - Frame ID, идентификатор картинки<br>
SID - Script ID, идентификатор скрипта<br>
Sound ID, идентификатор звукового файла<br>
<ul><i>номера записей в текстовых файлах</i></ul>
MSG IDX - номер записи в MSG файле<br>
MAP IDX - идентификатор карты (номер секции в MAPS.TXT)<br>
AI IDX - номер пакета AI (в AI.TXT)<br>
GVAR IDX - номер GVAR (глобальной переменной игры)<br>
<ul><i>имена записей в текстовых файлах</i></ul>
MAP NAME - имя секции описания карты в MAPS.TXT<br>
NAME - имя секции в текстовом файле<br>
</ul>
<hr></div>
</div>
<div id="node-101" class="section-3">
<h1 class="book-heading">2. Объекты карты мира</h1>
<p>
Объекты карты мира - это сама <i>карта мира</i>, а также <i>города</i> и <i>случайные встречи</i> (random encounter) в пустыне. Отдельным видом случайной встречи является специальная встреча (special encounter).
</p><div id="node-102" class="section-4">
<h1 class="book-heading">2.1. Карта мира</h1>
<p>Карта мира состоит из отдельных тайлов (FRM файл с изображением
куска карты) - 4 по горизонтали, 5 по вертикали, всего 20. Каждый тайл
содержит 42 (7х6) квадрата карты мира. Квадраты отделены желтыми
полосками.
</p>
<p>Для определения, по какой местности игрок может ходить, а по какой -
не может, используются маски карты мира. Для каждого тайла может
существовать своя маска.
</p>
<p>
Не забудьте также, что для такого объекта, как карта мира, существует свой музыкальный трек. Он жестко прописан в движке игры.
</p></div>
<div id="node-103" class="section-4">
<h1 class="book-heading">2.2. Случайные встречи</h1>
<p>Случайные встречи прописаны в WORLDMAP.TXT. Следующий рисунок
пояснит структуру WORLDMAP.TXT и связи объектов "карта мира" и
"случайная встреча".
</p>
<p>
</p><center>
<img alt="Worldmap and encounters" src="concept_files/encounter.gif" border="0">
</center>

<p>Как вы видите, движок читает из WORLDMAP.TXT секции описания тайлов
[Tile], в которых прописаны лист-индекс картинки тайла и имя файла
маски. Для каждого квадрата карты мира в секции [Tile] прописано имя
секции [Encounter Table], в которой описываются типы случайных встреч
этого квадрата.
</p>
<p>Для каждой случайной встречи в [Encounter Table] хранится имя
локации в MAPS.TXT и имя секции [Encounter], описывающей случайную
встречу. Для специальной встречи указывается только имя локации в
MAPS.TXT.
</p>
<p>В секции [Encounter] хранятся PID'ы криттеров, с которыми происходит
встреча, лист-индексы скриптов криттеров и вещей в их инвентаре,
лист-индексы предметов на земле.
</p>
<p>
В MAPS.TXT содержится имя файла карты местности и GAM-файла для нее.
</p>
<p>Имя и описание случайной встречи движок находит в файле
WORLDMAP.MSG. Т.к. никаких номеров текстовых записей в описании встреч
не содержится, то как он их находит - известно одному ему. Ясно только,
что порядок записей в WORLDMAP.MSG соответствует порядку записей в
MAPS.TXT (для имен локаций) и в секциях [Encounter Table] файла
WORLDMAP.TXT (для описаний встреч).
</p></div>
<div id="node-104" class="section-4">
<h1 class="book-heading">2.3. Города</h1>
<p>
Города, если кто забыл - это зеленые кружки на карте мира. Информацию о них движок извлекает из файла CITY.TXT. См. рисунок.
</p>
<p>
</p><center>
<img alt="City" src="concept_files/city.gif" border="0">
</center>

<p>Как вы видите, в CITY.TXT указываются лист-индексы картинки с картой
города (показывается, когда вы заходите в город - для выбора той части
города, куда вы хотите отправиться) и картинки с названием города
(плашки - рисуется рядом с кнопкой путешествия в город). Там же, в
CITY.TXT, указывается имя локации в MAPS.TXT.
</p>
<p>
Локация - это какая-то часть города (например, Траппер таун в Клемате). См. в CITY.TXT параметры entrance и все поймете.
</p>
<p>
В MAPS.TXT указываются имя файла карты местности и GAM-файла для нее, а также имена файлов музыки и звуков окружения для карты.
</p>
<p>Имена города, локации и карты извлекаются движком из файлов
WORLDMAP.MSG и MAP.MSG. Номера записей в этих файлах нигде прямо не
указаны, известно лишь, что порядок расположения имен соответствует
порядку расположения объектов в файлах CITY.TXT, WORLDMAP.TXT и
MAPS.TXT (см. рисунок).
</p></div>
</div>
<div id="node-105" class="section-3">
<h1 class="book-heading">3. Карта местности</h1>
<p>Когда игрок заходит в город или встречается с кем-либо в пустыне,
загружается карта местности. Карта состоит из тайлов, на ней
расположены различные объекты. Все это указывается в файле MAP.
</p>
<p>
</p><center>
<img alt="Map" src="concept_files/map.gif" border="0">
</center>

<p>При загрузке карты движок сразу же считывает и одноименный файл GAM,
содержащий переменные карты (MVAR). Некоторые параметры карты (в т.ч.
имена файлов музыки и звуков окружения) находятся в MAPS.TXT (MAP IDX -
номер секции описания карты в этом файле). SID скрипта карты
указывается непосредственно в файле MAP.
</p>

<p>Для сохраняемых карт файл MAP считывается только при первом заходе
игрока на карту. После сохранения игры, карта местности загружается уже
из файла SAV в сохраненках. Правда формат SAV это по сути тот же MAP.
</p>
<p>В массиве тайлов пола и потолка указывается только лист-индекс
PRO-файла тайла. А в области объектов для каждого объекта на карте
(кроме тайлов) указывается его PID, Script ID, FRM ID, а также другие
параметры (см. описание формата MAP).
</p>
<p>
В файле карты прописываются также т.н. spatial-скрипты. Они привязываются к отдельным хексам на карте.
</p></div>
<div id="node-106" class="section-3">
<h1 class="book-heading">4. Объекты на карте</h1>
<p>
У каждого объекта в игре есть свой прототип (PRO-файл), в котором указываются параметры объекта (см. описание файлов PRO).
</p>
<p>
Всего на карте может находится 6 типов объектов:
</p>
<p>
</p><table width="100%" border="1" bordercolor="#cccccc">
<tbody><tr><th>Тип объекта</th> <th>Описание</th></tr>
<tr><td>items</td> <td>предметы</td></tr>
<tr><td>critters</td> <td>существа</td></tr>
<tr><td>scenery</td> <td>объекты окружения, "декорации"</td></tr>
<tr><td>walls</td> <td>стены</td></tr>
<tr><td>tiles</td> <td>плитки пола и потолка</td></tr>
<tr><td>misc</td> <td>прочее</td></tr>
</tbody></table>

<p>
</p><center>
<img alt="Prototype" src="concept_files/proto.gif" border="0">
</center>

<p>Белый цвет на рисунке означает, что этот параметр есть у каждого
объекта, зеленый - только у некоторых, красный цвет - только у
криттеров, голубой - только у предметов.
</p>
<p>У каждого объекта есть его изображение на карте (FRM файл -
обращение по FID), а также имя и описание (обращение к нужной строке -
по индексу в соответсвующем MSG файле (pro_crit.msg, pro_item.msg и
т.д.)).
</p>
<p>У предметов есть также изображение их в инвентаре (INVEN FRM), а у
криттеров может быть изображение "говорящей головы" (HEAD FRM), т.е.
изображение лица в режиме диалога.
</p>
<p>У большинства объектов также указывается скрипт (обращение - по
Script ID) и звук (файл ACM, обращение - по Sound ID). Имя MSG-файла
сообщений скрипта (обычно это фразы для диалога) совпадает с именем
файла скрипта, поэтому считается, что обращение к нему осуществляется
также по Script ID.
</p>
<p>
В PROTO.MSG хранятся некоторые названия и описания, относящиеся к параметрам объекта.
</p>
<p>
Сообщения о ранениях и повреждениях различных частей тел криттеров находятся в файле COMBAT.MSG.<br>
Номера (MSG IDX) тех сообщений, которые не зависят от типа криттера или относятся игроку, прописаны в движке.<br>MSG
IDX сообщений, называющих части тела криттеров (с записи 1110),
соответствуют base_art_num (второй параметр в art\critters\critters.lst)<br>
MSG IDX сообщений о критических попаданиях (с записи 1450), соответствуют Kill type криттера (см. формат PRO-файлов).
</p>
<p>
Фразы персонажей во время боя (боевые крики) находятся в файлах
COMBATAI.MSG, CMBATAI2.msg (хотя второй скорее всего не используется).<br>
MSG IDX боевых криков прописаны в AI.TXT.
</p></div>
<div id="node-107" class="section-3">
<h1 class="book-heading">5. "Говорящие головы"</h1>
<p>
Диалоги с некоторыми персонажами анимированы и озвучены. Это так называемые "говорящие головы". Начинается все с их скрипта.
</p>
<p>
</p><center>
<img alt="Talking heads" src="concept_files/heads.gif" border="0">
</center>

<p>
Script ID берется из параметров объекта на карте, а не из PRO-файла. В
самом скрипте при вызове диалога указываются лист-индекс картинки фона
(зависит от локации, на которой происходит разговор), лист-индекс файла
MSG с репликами диалога, лист-индекс анимации мимики "говорящей головы"
и отношение персонажа к игроку (reaction).
</p>
<p>В файле диалога (MSG) указываются имена файлов синхронизации озвучки
и мимики (LIP), в которых, в свою очередь, указываются имена файлов
озвучки (ACM).
</p>
<p>Исходя из отношения криттера к игроку, лицо у персонажа может быть
довольным, сердитым или нейтральным. В соответствии с файлом LIP движок
проигрывает анимацию речи во время звучания фразы персонажа. Обращение
к конкретной картинке происходит по FRM ID.
</p></div>
<div id="node-108" class="section-3">
<h1 class="book-heading">6. Игрок</h1>
<p></p><div id="node-109" class="section-4">
<h1 class="book-heading">6.1. Стартовые персонажи</h1>
<p>
Файлы стартовых персонажей или premade PC (выбираемые в самом начале игровые персонажи), находятся в master.dat\premade\.
</p>

<p>
</p><center>
<img alt="Premade" src="concept_files/premade.gif" border="0">
</center>


<p>"Готовых" героев всего 3, с каждым героем связаны три файла: портрет
(FRM), биография (BIO) и характеристики (GCD). Файлы имеют разные
расширения, но называются соответственно (имена файлов жестко прошиты в
движке):
</p><ul>
combat.* - для Нарга (Narg)<br>
stealth.* - для Мингана (Mingan)<br>
diplomat.* - для Читсы (Chitsa)<br>
</ul>
</div>
<div id="node-110" class="section-4">
<h1 class="book-heading">6.2. Игрок</h1>
<p>Управляет объектом "игрок", конечно же, движок, и очень многое
прошито именно в нем. Все, что не прошито в движке, находится в
следующих файлах.
</p>

<p>
</p><center>
<img alt="Dude" src="concept_files/dude.gif" border="0">
</center>


<p>
Во-первых, у игрока есть свой собственный скрипт, работающий на любой карте, кроме карты мира.
</p>
<p>В файле VAULT13.GAM хранятся глобальные переменные (GVAR'ы) игры,
относящиеся по большей части к игроку (привыкания, звания, кармические
звания, репутации в городах, стадии выполнения квестов).
</p>
<p>
В файле ENDDEATH.TXT находятся настройки описаний смертей игрока.
</p>
<p>
В файле GENREP.TXT содержатся настройки кармических званий (Спаситель Проклятых, Дьявольское Отродье) игрока.
</p>
<p>
В файле KARMAVAR.TXT описываются настройки званий игрока (Берсеркер, Чемпион, Убийца детей).
</p>
<p>
В файле EDITOR.MSG содержатся названия и описания званий игрока (в т.ч. кармических).
</p>
<p>В файлах STAT.MSG, TRAIT.MSG, SKILL.MSG и PERK.MSG содержатся
описания соответственно характеристик, черт, умений и навыков игрока.
</p>
<p>Текущие параметры (инвентарь, GVAR'ы, карма, характеристики, умения,
навыки, уровень, опыт и т.д.) игрока содержатся в сохраненных играх в
файле SAVE.DAT.
</p></div>
<div id="node-111" class="section-4">
<h1 class="book-heading">6.3. Пип-бой</h1>
<p>С игроком связан один интересный объект - его портативный лэптоп,
известный в народе как пип-бой. Управляется он также движком. На нем
хранится информация с голодисков, видеоролики, записи о квестах и карты
локаций.
</p><div id="node-112" class="section-5">
<h1 class="book-heading">6.3.1. Голодиски</h1>
<p>
С голодисками связано три файла.
</p>

<p>
</p><center>
<img alt="Pipboy" src="concept_files/holodisk.gif" border="0">
</center>



<p>
В файле HOLODISK.TXT находятся настройки голодисков для пип-боя.
</p>
<p>
В файле VAULT13.GAM находится GVAR, показывающая, прочитан голодиск или нет.
</p>
<p>
В файле PIPBOY.MSG находятся названия и содержимое голодисков.
</p></div>
<div id="node-113" class="section-5">
<h1 class="book-heading">6.3.2. Квесты</h1>
<p>Описания квестов показываются в пип-бое в разделе "Статус". Они
разделены на группы по городам, в которых эти квесты были получены.
</p>

<p>
</p><center>
<img alt="Quest" src="concept_files/quest.gif" border="0">
</center>


<p>
В файле QUESTS.TXT находятся настройки описаний квестов для пип-боя.
</p>
<p>
В файле VAULT13.GAM находится GVAR, показывающая прогресс выполнения квеста.
</p>
<p>
В файле QUESTS.MSG находятся описания квестов для пип-боя.
</p>
<p>
В файле MAP.MSG находятся названия городов.
</p></div>
</div>
</div>
<div id="node-114" class="section-3">
<h1 class="book-heading">7. Партия</h1>
<p></p><div id="node-115" class="section-4">
<h1 class="book-heading">7.1. Команда</h1>
<p>
Список параметров (поведение в бою и повышение уровня), а также PID'ы партийцев указываются в PARTY.TXT. 
</p>

<p>
</p><center>
<img alt="Party" src="concept_files/party.gif" border="0">
</center>


<p>Само присоединение партийца к игроку производится в его скрипте.
Первоначально Script ID скрипта берется не из PRO, как вы понимаете, а
из параметров объекта на карте. Но при присоединении и повышении уровня
партийца, SID, вероятно, берется из PRO-файла. На рисунке для простоты
указана связь через PRO. PRO-файлы партийцев сохраняются в сейвах.
</p>
<p>
Текст, используемый в режиме "отдачи команд" партийцам находится в файле CUSTOM.MSG.
</p>
<p>
Текст сообщений о повышении партийцем уровня находится в MISC.MSG.
</p></div>
<div id="node-116" class="section-4">
<h1 class="book-heading">7.2. Машина</h1>
<p>
Машина, как видите, относится к партийцам, и ее PID указывается в PARTY.TXT.
</p>

<p>
</p><center>
<img alt="Car" src="concept_files/car.gif" border="0">
</center>


<p>В режиме карты мира управление машиной осуществляется движком (как
бы нелепо это ни звучало). Имеется в виду изменение скорости
передвижения по карте мира при покупке и апгрейде машины, слежение за
уровнем топлива, остановка при отсутствии топлива. Картинка машины,
появляющаяся справа в режиме карты мира, прописана, сами понимаете, в
движке. Ее FRM: art\intrface\WMCARMVE.FRM.
</p>
<p>Созданием машины на карте местности занимается скрипт карты. Машина
состоит из двух частей: багажника, являющегося контейнером (item) и
основной части (scenery).
</p></div>
</div>
<div id="node-117" class="section-3">
<h1 class="book-heading">8. Интерфейс</h1>
<p></p><div id="node-118" class="section-4">
<h1 class="book-heading">8.1. Видеоролики</h1>
<p>Видеоролики - файлы MVE. Вызываться они могут из скриптов, либо
непосредственно движком при наступлении определенных событий. При этом
используется просто номер видеролика (MVE IDX). Номера эти жестко
прописаны в движке (также как и имена файлов видеороликов). У каждого
видеролика (или какой-то его части) может быть своя собственная палитра
(PAL), которая тоже жестко прописана в движке.
</p>

<p>
</p><center>
<img alt="Video" src="concept_files/video.gif" border="0">
</center>


<p>С каждым видеороликом связаны файлы настроек (CFG), в которых
прописываются эффекты затемнения в ролике и файлы субтитров (SVE). Они
имеют такие же имена файлов, как и файл MVE.
</p>
<p>
Названия видеороликов (показываются в пип-бое) находятся в файле PIPBOY.MSG.
</p></div>
<div id="node-119" class="section-4">
<h1 class="book-heading">8.2. Слайд-шоу</h1>
<p>
Слайд-шоу показывают в конце игры. Оно повествует о судьбе городов и персонажей игры.
</p>
<p>
</p><center>
<img alt="Slides" src="concept_files/slides.gif" border="0">
</center>

<p>
Настройки слайд-шоу находятся в файле ENDGAME.TXT.
</p>
<p>
В файле VAULT13.GAM находятся GVAR, в которых указано, что случилось с тем или иным городом.
</p>
<p>
Сам слайд находится в art\intrface\. Обращение к нему - по лист-индексу.
</p>
<p>
Субтитры для слайда находятся в текстовых файлах (text\english\game\nar_*.txt).
</p></div>
</div>
</div>
</div>

</body></html>