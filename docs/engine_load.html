<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en"><head>

<title>Как движок Fallout2 работает с файлами</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- base href="http://teamx.ru/" -->
<style type="text/css">
</style>
</head><body>
<div class="section-1">
<div id="node-86" class="section-2">
<h1 class="book-heading">Как движок Fallout2 работает с файлами</h1>
<p>Данные исследования проводились Red!'ом с целью ускорения загрузки
игрой файлов ("быстрый Fallout"). В ходе исследований были получены
некоторые "побочные", но очень интересные результаты. Прочтение этого
документа позволит вам лучше понять то, как игра (и маппер) загружает и
сохраняет свои файлы. Перед прочтением рекомендуется ознакомиться с <a href="http://teamx.ru/node/57">Файловой структурой Fallout2</a>.
</p>
<p>
Оригинальную версию его исследований вы найдете здесь: <a href="http://nma-fallout.com/forum/viewtopic.php?t=7281">How the FO2 engine finds it's data</a>, перевод - здесь: <a href="http://www.teamx.ru/cgi-bin/ikonboard/topic.cgi?forum=14&amp;topic=9">Как движок Fallout2 обнаруживает файлы с данными</a>.
</p>
<p>
Исследования публиковались Red!'ом на форуме NMA. Ниже они сформулированы в виде кратких тезисов, для вашего удобства.
</p>

<hr>
<h4>Тезисы</h4>
<ul>
<li>Концепция "корня данных" - игра загружает файлы из заранее
определенных мест, называемых "корнями данных". Назовем корнеь данных
просто «<b></b>root<b></b>».<br>
Порядок загрузки данных: <br>
0. SAVEGAME <br>
1. patchXXX.dat <br>
2. critter_patches <br>
3. critter_dat <br>
4. master_patches <br>
5. master_dat <br>
6. Текущая директория <br>
7. Если найти данные не получилось, движок пытается продолжить без них, настолько изящно, насколько может.<br>
</li>
<li>Движок может загружать данные как из DAT файлов, так и из
директорий, при этом различий в том, на что указывает корень данных -
на DAT-файл или директорию, практически нет (замечу, что движок
загружает из DAT-файлов только стандартные папки (см. Файловую
структуру) - папки, задаваемые в скриптах, он из DAT-файлов загружать
не может).</li>
<li>Если файл/директория отсутствуют, движок их создаст (за исключением patchXXX.dat).</li>
<li>Если "корни данных" совпадают, движок не будет искать файл в той же
директории дважды (это не касается текущей директории - в ней он будет
искать файлы в любом случае).</li>
<li>Движок ищет (в текущей директории, не в директории Фоллаута) файлы
от patch000.dat до patch998.dat через шаг (т.е. только четные номера).
Найдя первый файл (с младшим номером), последующие он не ищет.</li>
<li>Игра удаляет все master_patches\proto\items\*.pro и master_patches\proto\critters\*.pro.<br>
Решения этой проблемы пока найдено 3:<br>
1. Ставить на файлы атрибут "только чтение"<br>
2. Использовать другие корни<br>
3. Использовать bat-файл (который будет использовать один из двух вышеуказанных методов)<br>
Подробнее см. <a href="http://www.teamx.ru/fop/docs/FScript-HOWTO/fmod_faq2.htm">FAQ</a>.
</li>
<li>Чтобы сохраненки работали, нужно чтобы critter_patches и master_patches указывали на одну и ту же директорию!</li>
<li>mapper2 в основном работает также, однако он не ищет patchXXX.dat! Он сохраняет свои данные в master_patches.</li>
<li>Опция "language" в Fallout2.cfg указывает директорию с текстом (можно сохранять текст, например, в text\russian\).</li>
<li>Интересны пути music_path1 и music_path2. По существу, игра ищет в
этих папках (сначала в первой, я полагаю) музыку. Отмечу, что, в
отличие от dat'ов, она не смотрит в текущих директориях и плюс ко
всему, ищет в обеих, даже если они совпадают. Также вы не можете
указать их на DAT файлы.</li>
<li>Игра не видит файлы в DAT'е, если они расположены не в алфавитном
порядке. Игра не различает регистра символов при поиске в DAT'е.</li>
<li>Если игра находит *.SAV файлы в любой другой «<b></b>root<b></b>»/MAPS
директории, кроме master_patches, игра будет жаловаться, что сохранение
невозможно. Так что удостоверьтесь, что удалили все *.SAV файлы,
находящиеся не в директории SAVEGAME.</li>
<li>Для "быстрого" Фоллаута: извлеките все в главную директорию
Фоллаута (не в \data!) Таким образом, если файл отсутствует, будет
проверяться тот же файл (что должно быть быстрее, чем проверять другой
файл, так как он непременно будет кеширован). Отредактируйте
Fallout2.cfg и пропишите полный путь до главной директории Фоллаута.
Наконец, не забудьте поставить на ваши proto/items/*.pro и
proto/critters/*.pro флаг "только чтение"! После этого игра должна
загружать данные быстрее (при втором запуске - помните, что при первом
запуске она может создавать файлы (wolrdmap.dat) и кеш не заполнен).
Главной причиной увеличения скорости будет, однако, распаковка, а не
изменения "корней", хотя все, конечно, помогает).</li>
<li>Всякий раз, когда вы выходите с карты (это означает, что вы
переходите с карты на карту, сохраняете игру или выходите на карту
мира), сначала игра пытается создать \MAPS, \proto\items и
\proto\critters (я не пытался помешать этому, чтобы посмотреть, не
пытается ли игра создать другие директории, если не получится создать
эти); затем игра записывает все critter PIDs, содержащиеся в
data/party.txt в первую доступную директорию proto/critters, также
записывается 00000455.pro (багажник) в первую найденную proto/items в
списке корней и наконец, сохраняет карту под ее стандартным именем,
изменяя расширение на SAV, в первой найденной директории MAPS. [Есть
еще несколько обновляемых файлов, но они не заслуживают внимания.]
Когда сохраняете игру (после того, как пройден предыдущий шаг), это
много раз повторяется для корректных слотов /SAVEGAME/SLOTXX.
Когда переходите на другую карту, игра находит прохи, которые она
только что записала и использует их вместо тех, что лежат в данных (это
могло быть причиной того, почему пути должны совпадать, хотя это может
не соблюдаться, если patch000.dat - файл, а не директория - недосмотр?
Или, возможно, они не позаботились об этом, потому что в патче нет
"рискованных" прох).</li>
</ul>

<hr>
<h4>Об авторе</h4>
<p>
Автор исследований - <b>Red!</b> (<a href="mailto:red_nnnno@hotmail.com">red_nnnno@hotmail.com</a>) (DAC, NMA)<br>
Перевод - Perceptron (<a href="mailto:perceptron@pisem.net">perceptron@pisem.net</a>)
</p></div>
</div>

</body></html>